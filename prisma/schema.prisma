// =============================================================================
// Echo Mail Database Schema
// Updated: 2025-11-18 - Force Prisma Client regeneration for Vercel
// =============================================================================

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// 업체 및 담당자 관리
// =============================================================================

model Company {
  id        String   @id @default(cuid())
  name      String
  email     String
  region    String
  isActive  Boolean  @default(true)

  // 멀티테넌시
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관계
  contacts      Contact[]
  emailLogs     EmailLog[]
  notifications NotificationLog[]

  // 테넌트 내에서 유니크
  @@unique([tenantId, name])
  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, region])
  @@index([createdAt])
  @@map("companies")
}

model Contact {
  id       String  @id @default(cuid())
  name     String
  phone    String
  email    String?
  position String?
  isActive Boolean @default(true)

  // 알림 설정
  smsEnabled   Boolean @default(true)
  kakaoEnabled Boolean @default(false)

  // 멀티테넌시
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // 관계
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, companyId])
  @@index([phone])
  @@index([email])
  @@index([companyId])
  @@map("contacts")
}

// =============================================================================
// 납품 규칙 관리
// =============================================================================

model DeliveryRule {
  id     String @id @default(cuid())
  region String

  // 납품 규칙 (단순화)
  cutoffTime String // 마감 시간 (HH:mm)

  // 납기일 계산
  beforeCutoffDays Int @default(1) // 마감 전 주문 -> N일 후
  afterCutoffDays  Int @default(2) // 마감 후 주문 -> N일 후

  // 배송 시간대 선택
  beforeCutoffDeliveryTime String @default("오전") // 마감 전 주문 배송 시간 ("오전" or "오후")
  afterCutoffDeliveryTime  String @default("오후") // 마감 후 주문 배송 시간 ("오전" or "오후")

  // 2차 마감 설정 (옵션)
  cutoffCount               Int     @default(1) // 마감 횟수 (1 or 2)
  secondCutoffTime          String? // 2차 마감 시간 (HH:mm)
  afterSecondCutoffDays     Int?    // 2차 마감 후 주문 -> N일 후
  afterSecondCutoffDeliveryTime String? // 2차 마감 후 주문 배송 시간 ("오전" or "오후")

  // 영업일 설정 (유연한 휴무일 관리)
  workingDays       String[] @default(["1", "2", "3", "4", "5"]) // 영업 요일 (0=일요일, 6=토요일)
  customClosedDates String[] @default([]) // 커스텀 휴무일 (YYYY-MM-DD 형식)
  excludeHolidays   Boolean  @default(true) // 공휴일 제외 여부

  // 멀티테넌시
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 테넌트 내에서 지역별 유니크
  @@unique([tenantId, region])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([region])
  @@map("delivery_rules")
}

model Holiday {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  name        String
  isRecurring Boolean  @default(false) // 매년 반복 여부

  // 멀티테넌시
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 테넌트 내에서 날짜별 유니크
  @@unique([tenantId, date])
  @@index([tenantId])
  @@index([date])
  @@index([tenantId, isRecurring])
  @@map("holidays")
}

// =============================================================================
// 메일 처리 및 로그
// =============================================================================

// 테넌트별 이메일 계정 설정
model EmailAccount {
  id String @id @default(cuid())

  // 계정 정보
  email    String
  password String // 암호화하여 저장

  // IMAP 설정
  imapHost  String
  imapPort  Int     @default(993)
  imapSecure Boolean @default(true)

  // SMTP 설정 (선택사항 - 답장용)
  smtpHost  String?
  smtpPort  Int?    @default(587)
  smtpSecure Boolean @default(false)

  // 폴링 설정
  pollInterval Int     @default(60) // 초 단위
  isActive     Boolean @default(true)

  // 마지막 동기화 정보
  lastSyncAt   DateTime?
  lastErrorAt  DateTime?
  lastErrorMsg String?

  // 멀티테넌시
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 테넌트별 유니크
  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([lastSyncAt])
  @@map("email_accounts")
}

model EmailLog {
  id String @id @default(cuid())

  // 메일 정보
  messageId  String
  subject    String
  sender     String
  recipient  String
  receivedAt DateTime

  // 메일 본문 (메일 뷰어용)
  body       String? @db.Text // Plain text 본문
  bodyHtml   String? @db.Text // HTML 본문

  // 메일 상태 (메일 뷰어용)
  isRead     Boolean @default(false) // 읽음 여부
  folder     String  @default("INBOX") // 메일함 (INBOX, SENT 등)
  size       Int?    // 메일 크기 (bytes)
  isOrder    Boolean @default(false) // 발주 메일 여부 (빠른 필터링용)

  // 첨부파일 정보
  hasAttachment Boolean @default(false)
  attachments   Json? // 첨부파일 목록

  // 처리 상태
  status      EmailStatus @default(RECEIVED)
  processedAt DateTime?

  // 멀티테넌시
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // 업체 매칭
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  // 에러 정보
  errorMessage String?

  // 관계
  notifications NotificationLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 테넌트 내에서 메시지 ID 유니크
  @@unique([tenantId, messageId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, companyId])
  @@index([tenantId, folder])
  @@index([tenantId, isRead])
  @@index([tenantId, isOrder])
  @@index([receivedAt])
  @@index([sender])
  @@index([recipient])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}

enum EmailStatus {
  RECEIVED // 수신됨
  PROCESSED // 처리됨
  MATCHED // 업체 매칭됨
  FAILED // 처리 실패
  IGNORED // 무시됨 (미등록 업체)
}

// =============================================================================
// 알림 발송 관리
// =============================================================================

model NotificationLog {
  id String @id @default(cuid())

  // 발송 정보
  type      NotificationType
  recipient String // 전화번호 또는 카카오톡 ID
  message   String

  // 상태 관리
  status      NotificationStatus @default(PENDING)
  sentAt      DateTime?
  deliveredAt DateTime?

  // 재시도 정보
  retryCount  Int       @default(0)
  maxRetries  Int       @default(3)
  nextRetryAt DateTime?

  // 에러 분류 (재시도 가능 여부 판단)
  errorCode   String?   // 에러 코드 (TIMEOUT, AUTH_ERROR, NETWORK_ERROR 등)

  // Provider 메시지 ID (중복 발송 방지)
  providerMessageId String? // Provider에서 반환한 messageId

  // 멀티테넌시
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // 관련 정보
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  contactId String?  // 담당자 ID (유니크 키 구성)

  emailLogId String?
  emailLog   EmailLog? @relation(fields: [emailLogId], references: [id])

  // 에러 정보
  errorMessage String?

  // 비용 정보
  cost Decimal? @db.Decimal(10, 4)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 복합 유니크 키: 동일 테넌트, 동일 메일, 동일 담당자, 동일 타입에 대해 하나의 로그만 유지
  // 이를 통해 upsert 시 중복 생성 방지
  @@unique([tenantId, emailLogId, contactId, type], name: "notification_unique_per_contact")

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, type])
  @@index([status, nextRetryAt])
  @@index([recipient])
  @@index([emailLogId])
  @@index([companyId])
  @@index([contactId])
  @@index([createdAt])
  @@index([sentAt])
  @@index([providerMessageId])
  @@map("notification_logs")
}

enum NotificationType {
  SMS
  KAKAO_ALIMTALK
  KAKAO_FRIENDTALK
}

enum NotificationStatus {
  PENDING // 대기 중
  SENDING // 발송 중
  SENT // 발송됨
  DELIVERED // 전달됨
  FAILED // 실패
  CANCELLED // 취소됨
  PENDING_RETRY // 재시도 대기 (실패 후 재시도 예정)
}

// =============================================================================
// 시스템 설정 및 관리
// =============================================================================

model SystemConfig {
  id          String  @id @default(cuid())
  key         String
  value       String
  description String?
  category    String  @default("general")

  // 멀티테넌시
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 테넌트 내에서 키별 유니크
  @@unique([tenantId, key])
  @@index([tenantId])
  @@index([tenantId, category])
  @@index([key])
  @@map("system_configs")
}

model MessageTemplate {
  id        String           @id @default(cuid())
  name      String
  type      NotificationType
  subject   String? // 알림톡의 경우
  content   String
  variables Json? // 사용 가능한 변수 목록

  // 멀티테넌시
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 테넌트 내에서 이름별 유니크
  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, isActive])
  @@index([tenantId, isDefault])
  @@map("message_templates")
}

// =============================================================================
// SaaS 멀티테넌시 시스템
// =============================================================================

model Tenant {
  id               String             @id @default(cuid())
  name             String
  subdomain        String             @unique
  customDomain     String?
  subscriptionPlan SubscriptionPlan   @default(FREE_TRIAL)
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  trialEndsAt      DateTime

  // 소유자 (Supabase Auth UUID)
  ownerId          String             // auth.users.id 참조

  // 소유자 정보 (중복 저장)
  ownerEmail       String
  ownerName        String?

  // 알림 발신번호 설정
  senderPhone      String?            // 발신번호 (010-1234-5678)
  senderVerified   Boolean            @default(false) // 발신번호 인증 여부
  senderVerifiedAt DateTime?          // 발신번호 인증 일시
  ncpCallingNumberId String?          // NCP 발신번호 ID

  // 사용량 제한
  maxCompanies     Int @default(10)
  maxContacts      Int @default(50)
  maxEmails        Int @default(500)
  maxNotifications Int @default(1000)

  // 메일 기능 옵션 (Phase 7)
  mailMode           MailMode @default(ORDER_ONLY) // 메일 수신 모드
  mailSendingEnabled Boolean  @default(false)      // 메일 발신 기능 사용 여부

  // 발주 키워드 설정
  orderKeywords      String[] @default(["발주", "주문", "구매", "납품", "order", "purchase", "po"])
  keywordsDisabled   Boolean  @default(false)      // 키워드 무시 (이메일 주소만으로 발주 판단)

  // 관계
  companies        Company[]
  contacts         Contact[]
  deliveryRules    DeliveryRule[]
  holidays         Holiday[]
  emailLogs        EmailLog[]
  emailAccounts    EmailAccount[]
  notificationLogs NotificationLog[]
  messageTemplates MessageTemplate[]
  systemConfigs    SystemConfig[]
  subscriptions    Subscription[]
  invoices         Invoice[]
  members          TenantMember[] // 팀원 관리
  invitations      TenantInvitation[] // 초대 관리
  activityLogs     ActivityLog[] // 활동 로그

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([ownerId])
  @@index([ownerEmail])
  @@index([subdomain])
  @@index([customDomain])
  @@index([subscriptionPlan])
  @@index([subscriptionStatus])
  @@index([trialEndsAt])
  @@index([createdAt])
  @@map("tenants")
}

// 테넌트 멤버십 (Supabase Auth 사용자와 테넌트 연결)
model TenantMember {
  id        String   @id @default(cuid())

  // Supabase Auth UUID
  userId    String   // auth.users.id 참조
  userEmail String   // 중복 저장 (성능)
  userName  String?  // 중복 저장 (성능)

  // 테넌트
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // 역할
  role      TenantRole @default(MEMBER)

  // 상태
  status    MemberStatus @default(ACTIVE)

  // 초대 정보
  invitedBy    String?   // 초대한 사용자 ID
  invitedAt    DateTime  @default(now())
  acceptedAt   DateTime? // 초대 수락 시간

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 한 사용자는 하나의 테넌트에 한 번만 속할 수 있음
  @@unique([tenantId, userId])
  @@index([userId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([userEmail])
  @@map("tenant_members")
}

// 테넌트 초대
model TenantInvitation {
  id        String   @id @default(cuid())

  // 초대 정보
  email     String
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  role      TenantRole @default(MEMBER)
  token     String   @unique // 초대 토큰

  // 상태
  status    InvitationStatus @default(PENDING)

  // 메타데이터
  invitedBy String   // 초대한 사용자 ID
  invitedAt DateTime @default(now())
  expiresAt DateTime // 만료 시간 (7일)
  acceptedAt DateTime?
  acceptedBy String?  // 수락한 사용자 ID (Supabase UUID)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token])
  @@index([email])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([expiresAt])
  @@map("tenant_invitations")
}

enum TenantRole {
  OWNER   // 소유자 (모든 권한)
  ADMIN   // 관리자 (팀원 관리 제외 모든 권한)
  MEMBER  // 멤버 (기본 권한)
}

enum MemberStatus {
  ACTIVE    // 활성
  SUSPENDED // 정지
  INACTIVE  // 비활성
}

enum InvitationStatus {
  PENDING   // 대기중
  ACCEPTED  // 수락됨
  EXPIRED   // 만료됨
  CANCELLED // 취소됨
}

// 활동 로그
model ActivityLog {
  id          String   @id @default(cuid())

  // 테넌트
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // 사용자 정보
  userId      String
  userEmail   String
  userName    String?

  // 활동 정보
  action      String   // 'MEMBER_INVITED', 'MEMBER_JOINED', 'MEMBER_REMOVED', 'ROLE_CHANGED' 등
  description String
  metadata    Json     @default("{}")

  createdAt   DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@index([tenantId, createdAt(sort: Desc)])
  @@map("activity_logs")
}

enum SubscriptionPlan {
  FREE_TRIAL
  STARTER
  PROFESSIONAL
  BUSINESS
  ENTERPRISE
}

// 메일 수신 모드 (Phase 7)
enum MailMode {
  ORDER_ONLY  // 발주 메일만 수신 (기본값)
  FULL_INBOX  // 전체 메일 수신
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  UNPAID
  INCOMPLETE
}

model Subscription {
  id                    String             @id @default(cuid())
  tenantId              String
  tenant                Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  plan                  SubscriptionPlan
  status                SubscriptionStatus @default(ACTIVE)

  // 결제 정보
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean            @default(false)
  cancelledAt           DateTime?

  // 토스페이먼츠 연동
  customerKey           String?            // 고객 키
  billingKey            String?            // 빌링 키 (정기결제용)

  // 가격 정보
  priceAmount           Int                // 월 구독료 (원 단위)
  currency              String             @default("KRW")

  // 사용량 통계
  currentEmailCount     Int                @default(0)
  currentNotificationCount Int             @default(0)

  // 관계
  invoices              Invoice[]
  history               SubscriptionHistory[]

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  @@index([tenantId])
  @@index([plan])
  @@index([status])
  @@index([currentPeriodEnd])
  @@index([customerKey])
  @@index([billingKey])
  @@map("subscriptions")
}

// 구독 변경 이력
model SubscriptionHistory {
  id             String           @id @default(cuid())
  subscriptionId String
  subscription   Subscription     @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  previousPlan   SubscriptionPlan
  newPlan        SubscriptionPlan
  previousStatus SubscriptionStatus?
  newStatus      SubscriptionStatus?

  // 변경 유형: UPGRADE, DOWNGRADE, TRIAL_END, CANCEL, REACTIVATE
  changeType     String

  // 결제 정보 (있는 경우)
  paidAmount     Int?             // 결제 금액
  paymentId      String?          // 결제 ID (토스페이먼츠 등)

  changedAt      DateTime         @default(now())
  reason         String?          // 변경 사유

  @@index([subscriptionId])
  @@index([changedAt])
  @@index([changeType])
  @@map("subscription_history")
}

// =============================================================================
// 사용자 역할 (Supabase Auth 사용, 역할은 user_metadata에 저장)
// =============================================================================

enum UserRole {
  OWNER       // 소유자: 결제 관리, 테넌트 삭제 가능
  ADMIN       // 관리자: 모든 설정 가능
  MANAGER     // 매니저: 업체/담당자 관리
  OPERATOR    // 운영자: 알림 발송만
  VIEWER      // 뷰어: 읽기 전용
}

// 인보이스 및 결제
model Invoice {
  id              String         @id @default(cuid())

  // 관계
  tenantId        String
  tenant          Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  subscriptionId  String
  subscription    Subscription   @relation(fields: [subscriptionId], references: [id])

  // 인보이스 정보
  invoiceNumber   String         @unique
  status          InvoiceStatus  @default(PENDING)

  // 금액
  subtotal        Int            // 세전 금액 (원 단위)
  tax             Int            // 세금 (원 단위)
  total           Int            // 총 금액 (원 단위)
  currency        String         @default("KRW")

  // 기간
  periodStart     DateTime
  periodEnd       DateTime

  // 결제
  paidAt          DateTime?
  paymentMethod   String?        // 결제 방법

  // 토스페이먼츠 연동
  paymentKey      String?        // 토스페이먼츠 결제 키
  orderId         String?        // 주문 ID

  // PDF
  pdfUrl          String?        // PDF 다운로드 URL

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([tenantId])
  @@index([subscriptionId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([periodStart])
  @@index([periodEnd])
  @@index([paidAt])
  @@index([paymentKey])
  @@index([orderId])
  @@map("invoices")
}

enum InvoiceStatus {
  PENDING         // 결제 대기
  PAID           // 결제 완료
  FAILED         // 결제 실패
  CANCELLED      // 취소됨
  REFUNDED       // 환불됨
}

// =============================================================================
// 문의하기
// =============================================================================

model ContactInquiry {
  id          String        @id @default(cuid())

  // 문의자 정보
  name        String
  email       String
  phone       String?
  company     String?

  // 문의 내용
  type        InquiryType   @default(INQUIRY)
  subject     String
  message     String        @db.Text

  // 상태 관리
  status      InquiryStatus @default(PENDING)
  assignedTo  String?       // 담당자 이메일

  // 답변
  reply       String?       @db.Text
  repliedAt   DateTime?
  repliedBy   String?       // 답변자 이메일

  // 메타데이터
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([email])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("contact_inquiries")
}

enum InquiryType {
  INQUIRY       // 일반 문의
  DEMO          // 데모 요청
  PARTNERSHIP   // 제휴 문의
  SUPPORT       // 기술 지원
  BILLING       // 결제 문의
  OTHER         // 기타
}

enum InquiryStatus {
  PENDING       // 대기중
  IN_PROGRESS   // 처리중
  RESOLVED      // 해결됨
  CLOSED        // 종료
}

